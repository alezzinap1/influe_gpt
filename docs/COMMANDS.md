# Справочник команд

Полный список всех доступных команд в проекте.

## Основные команды (main.py)

### Telegram команды

#### `tg-sync` - Синхронизация канала
Скачивает полную историю канала из Telegram.

```bash
# В PowerShell используйте кавычки для аргументов с @
python main.py tg-sync "@channelname"

# Или без @ (оба варианта работают)
python main.py tg-sync channelname
```

**Что делает:**
- Подключается к Telegram через Telethon
- Скачивает все сообщения из канала
- Сохраняет в SQLite БД и parquet файлы
- Сохраняет метаданные (даты, просмотры, пересылки)

**Требования:**
- Настроенные `TG_API_ID` и `TG_API_HASH` в `.env`
- Файл сессии `my_session.session`

---

#### `tg-update` - Обновление канала
Обновляет историю канала (добавляет новые сообщения).

```bash
python main.py tg-update @channelname
```

**Что делает:**
- Проверяет последнее сообщение в БД
- Скачивает только новые сообщения
- Обновляет SQLite БД и parquet файлы

---

#### `tg-ingest` - Индексация канала
Индексирует канал в ChromaDB для поиска.

```bash
python main.py tg-ingest @channelname
```

**Что делает:**
- Загружает сообщения из parquet файлов
- Фильтрует короткие сообщения (<50 символов)
- Создает чанки по сообщениям (не по группам)
- Обрабатывает пересылки
- Применяет semantic chunking для длинных сообщений
- Извлекает keywords
- Добавляет в ChromaDB с эмбеддингами

**Параметры:**
- `min_chars=50` - минимальная длина сообщения
- `max_chars=600` - максимальная длина чанка

---

#### `tg-reindex` - Переиндексация канала
Переиндексирует канал без удаления данных из БД и файлов.

```bash
python main.py tg-reindex @channelname
```

**Что делает:**
- Удаляет старые данные из ChromaDB
- Сохраняет данные в SQLite БД
- Сохраняет parquet файлы
- Создает новые чанки с текущими параметрами

**Когда использовать:**
- Изменились параметры индексации
- Обновился код обработки сообщений
- Нужно применить новые улучшения

---

#### `tg-delete` - Удаление канала
Полностью удаляет канал из системы.

```bash
# В PowerShell используйте кавычки для аргументов с @
python main.py tg-delete "@channelname"

# Или без @ (оба варианта работают)
python main.py tg-delete channelname
```

**Что делает:**
- Удаляет канал из SQLite БД
- Удаляет чанки из ChromaDB
- Удаляет parquet файлы
- Удаляет саммари

**⚠️ Внимание:** Операция необратима! Все данные канала будут удалены.

**Альтернатива:** Можно использовать утилиту `delete_channel.py`:
```bash
python delete_channel.py @channelname
```

---

#### `tg-query` - Поиск по каналу
Задает вопрос к архиву канала и получает ответ на основе RAG.

```bash
python main.py tg-query @channelname "ваш вопрос" [--backend deepseek|openai|local]
```

**Параметры:**
- `@channelname` - имя канала
- `"вопрос"` - ваш вопрос
- `--backend` - выбор LLM (по умолчанию: `deepseek`)

**Что делает:**
- Извлекает keywords из вопроса
- Ищет релевантные чанки в ChromaDB
- Применяет BM25 reranking
- Формирует контекст из найденных чанков
- Генерирует ответ с помощью LLM
- Добавляет ссылки на источники

**Примеры:**
```bash
python main.py tg-query @channelname "что говорили про Python?"
python main.py tg-query @channelname "новости за 2024 год" --backend openai
```

---

#### `tg-build-summaries` - Построение саммари
Создает годовые и квартальные саммари канала.

```bash
python main.py tg-build-summaries @channelname
```

**Что делает:**
- Группирует сообщения по годам и кварталам
- Генерирует саммари с помощью LLM
- Сохраняет в JSON файлы
- Создает author-specific отчеты

**Требования:**
- Настроенный `SUMMARY_BACKEND` в `.env`
- API ключ для выбранного backend

---

#### `tg-index-summaries` - Индексация саммари
Индексирует созданные саммари в ChromaDB.

```bash
python main.py tg-index-summaries @channelname
```

**Что делает:**
- Загружает саммари из JSON файлов
- Добавляет в ChromaDB с эмбеддингами
- Позволяет искать по саммари в `tg-query`

---

### Служебные команды

#### `status` - Статус индекса
Показывает статистику по индексу.

```bash
python main.py status
```

**Выводит:**
- Общее количество чанков
- Количество чанков по каналам
- Количество саммари
- Размер базы данных

---

## Утилиты

### `reindex_all.py` - Массовая переиндексация
Переиндексирует все каналы из БД или файлов.

```bash
# Переиндексация всех каналов из БД
python reindex_all.py

# Переиндексация всех каналов из parquet файлов
python reindex_all.py --from-files
```

**Что делает:**
- Находит все каналы в БД или parquet файлы
- Переиндексирует каждый канал
- Показывает прогресс и результаты

---

### `fix_channels_db.py` - Исправление БД каналов
Нормализует имена каналов и удаляет дубликаты.

```bash
python fix_channels_db.py
```

**Что делает:**
- Нормализует имена каналов (убирает @, приводит к нижнему регистру)
- Удаляет дубликаты каналов
- Синхронизирует с ChromaDB

---

### `check_imports.py` - Проверка импортов
Проверяет синтаксис и импорты всех Python файлов.

```bash
python check_imports.py
```

**Что проверяет:**
- Синтаксис всех `.py` файлов
- Импорты легковесных модулей
- Отсутствие критических ошибок

---

### `sync_channel_status.py` - Синхронизация статуса
Синхронизирует статус каналов между SQLite БД и ChromaDB.

```bash
python sync_channel_status.py
```

**Что делает:**
- Проверяет соответствие каналов в БД и ChromaDB
- Обновляет статусы
- Выводит отчет о расхождениях

---

### `delete_channel.py` - Удаление канала
Удаляет канал из БД, ChromaDB и файлов.

```bash
python delete_channel.py @channelname
```

**Что делает:**
- Удаляет канал из SQLite БД
- Удаляет чанки из ChromaDB
- Удаляет parquet файлы
- Удаляет саммари

**⚠️ Внимание:** Операция необратима!

---

## Telegram бот

### Запуск бота

```bash
cd rag_mvp
python tgbot/bot.py
```

**Команды бота:**
- `/start` - приветствие
- `/help` - справка
- `/channels` - список каналов
- `/query <канал> <вопрос>` - поиск по каналу
- `/status` - статус системы

**Требования:**
- `TELEGRAM_BOT_TOKEN` в `.env`
- Только один экземпляр бота должен быть запущен

---

## Типичные сценарии использования

### Первичная настройка канала

```bash
# 1. Скачать историю
python main.py tg-sync @channelname

# 2. Индексировать
python main.py tg-ingest @channelname

# 3. Создать саммари
python main.py tg-build-summaries @channelname

# 4. Индексировать саммари
python main.py tg-index-summaries @channelname
```

### Обновление канала

```bash
# 1. Обновить историю
python main.py tg-update @channelname

# 2. Переиндексировать
python main.py tg-reindex @channelname
```

### Удаление канала

```bash
# Полное удаление канала (необратимо!)
python main.py tg-delete @channelname
```

**⚠️ Внимание:** Эта операция удалит:
- Все данные канала из SQLite БД
- Все чанки из ChromaDB
- Parquet файлы с сообщениями
- Саммари канала

### Поиск информации

```bash
# Поиск по каналу
python main.py tg-query @channelname "ваш вопрос"

# С другим backend
python main.py tg-query @channelname "вопрос" --backend openai
```

### Массовые операции

```bash
# Переиндексация всех каналов
python reindex_all.py

# Проверка системы
python check_imports.py
```

---

## Параметры и настройки

### Параметры индексации

Можно изменить в коде:
- `min_chars=50` - минимальная длина сообщения
- `max_chars=600` - максимальная длина чанка
- `top_k=5` - количество keywords

### Backend для LLM

Доступные варианты:
- `deepseek` - DeepSeek API (по умолчанию)
- `openai` - OpenAI API
- `local` - локальная модель (требует установки)

### Переменные окружения

См. [SETUP.md](docs/SETUP.md) для полного списка переменных.

