# Функции и улучшения

Описание всех функций системы и внедренных улучшений.

## Основные функции

### 1. Синхронизация каналов
- Скачивание полной истории Telegram каналов
- Инкрементальное обновление (только новые сообщения)
- Сохранение метаданных (даты, просмотры, пересылки)
- Хранение в SQLite БД и parquet файлах

### 2. Индексация
- Создание векторных эмбеддингов для поиска
- Фильтрация коротких сообщений (<50 символов)
- Обработка пересылок с указанием источника
- Semantic chunking для длинных сообщений
- Извлечение keywords для улучшения поиска

### 3. Поиск и RAG
- Семантический поиск по архиву
- Keyword-based предфильтрация
- BM25 reranking для точности
- Генерация ответов с помощью LLM
- Автоматическое добавление ссылок на источники

### 4. Саммари
- Автоматическое создание годовых саммари
- Квартальные саммари
- Author-specific отчеты
- Индексация саммари для поиска

## Внедренные улучшения

### 1. Semantic Chunking для длинных постов

**Когда применяется:** Сообщения длиной >500 символов

**Как работает:** Использует sentence-transformers для определения семантических границ

**Время:** ~0.05s на длинный пост (только при индексации)

**Выгода:** Улучшение границ чанков, сохранение контекста

### 2. Keyword Extraction при индексации

**Метод:** Быстрый TF-IDF подход (для коротких) или KeyBERT (для длинных)

**Количество:** 5 keywords на чанк

**Время:** ~0.001s на короткий чанк, ~0.01s на длинный

**Хранение:** Сохраняется в metadata как строка через запятую

### 3. Keyword-based предфильтрация

**Когда:** Перед semantic search в ChromaDB

**Как работает:** Фильтрует чанки по совпадению keywords из вопроса

**Время:** ~0.001s

**Выгода:** Сокращает количество кандидатов на 30-50%, ускоряет поиск

### 4. BM25 Scoring

**Когда:** При reranking результатов

**Как работает:** Использует BM25 алгоритм для точного keyword matching

**Время:** ~0.001s

**Выгода:** Более точный keyword scoring по сравнению с простым подсчетом

### 5. Умная фильтрация источников

**Проблема:** Источники указывали на первое сообщение из чанка, а не на наиболее релевантное

**Решение:** 
- Выбор сообщения с наибольшим количеством совпадений keywords
- Fallback на сообщение в середине чанка
- Использование кэша сообщений для быстрого доступа

**Выгода:** Более точные ссылки на источники

### 6. Обработка пересылок

**Проблема:** Пересылки считались как оригинальные сообщения автора

**Решение:**
- Определение пересылок при скачивании
- Добавление пометки `[Пересылка из {канал}]` в текст
- Сохранение метаданных о пересылке
- Отображение в контексте и источниках

**Выгода:** Корректная атрибуция контента

### 7. Индексация по сообщениям

**Проблема:** Несколько сообщений объединялись в один чанк, что снижало точность источников

**Решение:**
- Каждое сообщение = отдельный чанк
- Semantic chunking только для очень длинных сообщений (>500 символов)
- Фильтрация коротких сообщений (<50 символов)

**Выгода:** Более точная индексация и источники

### 8. Переиндексация без потери данных

**Функция:** `tg-reindex` и `reindex_all.py`

**Что делает:**
- Удаляет только из ChromaDB
- Сохраняет данные в SQLite БД
- Сохраняет parquet файлы
- Сохраняет саммари

**Выгода:** Безопасное обновление индексов без потери данных

## Производительность

### Индексация
- Короткие сообщения: +0.001s на чанк (keyword extraction)
- Длинные сообщения: +0.05s на пост (semantic chunking + keyword extraction)

### Запросы
- Keyword фильтрация: +0.001s, но ускоряет semantic search на 30%
- BM25 scoring: +0.001s
- **Итого**: ~0.55s (быстрее за счет предфильтрации)

## Настройки

Все настройки находятся в коде:
- Порог semantic chunking: 500 символов (в `telegram/ingest.py`)
- Количество keywords: 5 (в `utils/keywords.py`)
- Вес BM25: 2.0 (в `rag/pipeline.py`)
- Минимальная длина сообщения: 50 символов
- Максимальная длина чанка: 600 символов

## Обратная совместимость

- Старые чанки без keywords будут работать (проверка на наличие поля)
- Если keywords нет в metadata, используется fallback на старый метод
- Старые данные можно переиндексировать без потери

## Новые файлы

- `utils/keywords.py` - извлечение ключевых слов
- `utils/chunker.py` - семантическое разбиение текста
- `scripts/reindex_all.py` - массовая переиндексация

## Обновленные файлы

- `telegram/ingest.py` - добавлен semantic chunking и keyword extraction
- `rag/pipeline.py` - добавлены BM25 и keyword фильтрация
- `vectorstore/chromadb_store.py` - фильтрация None значений
- `utils/source_links.py` - умная фильтрация источников
- `requirements.txt` - добавлены keybert и rank-bm25

